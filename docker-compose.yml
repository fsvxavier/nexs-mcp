version: '3.8'

services:
  nexs-mcp:
    image: fsvxavier/nexs-mcp:latest
    container_name: nexs-mcp-server
    restart: unless-stopped
    
    # Port mapping (if needed for HTTP API in future)
    # ports:
    #   - "8080:8080"
    
    # Volume mounts
    volumes:
      # Data directory for elements (personas, skills, ensembles, agents, memories)
      - ./data:/app/data:rw
      # ONNX models cache (pre-loaded in image)
      - nexs-mcp-models:/app/models:rw
      # Transformers cache
      - nexs-mcp-cache:/root/.cache:rw
    
    # Environment variables
    environment:
      # === Core Configuration ===
      - NEXS_STORAGE_TYPE=filesystem
      - NEXS_DATA_DIR=/app/data
      - NEXS_TEST_MODE=false
      
      # === Logging Configuration ===
      - NEXS_LOG_LEVEL=info
      - NEXS_LOG_FORMAT=json
      
      # === Working Memory Configuration ===
      - NEXS_AUTO_SAVE_MEMORIES=true
      - NEXS_AUTO_SAVE_INTERVAL=30s
      
      # === Resources Protocol Configuration ===
      - NEXS_RESOURCES_ENABLED=false
      - NEXS_RESOURCES_CACHE_TTL=5m
      
      # === Embedding Provider Configuration ===
      # ONNX provider (default, pre-configured in image)
      - NEXS_EMBEDDING_PROVIDER=onnx
      - NEXS_TRANSFORMERS_CACHE=/app/models
      - NEXS_USE_GPU=false
      - LD_LIBRARY_PATH=/usr/local/lib
      
      # OpenAI provider (optional, requires API key)
      # - NEXS_EMBEDDING_PROVIDER=openai
      # - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      # - NEXS_OPENAI_MODEL=text-embedding-3-small
      
      # === GitHub Integration (optional) ===
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
      - GITHUB_CLIENT_ID=${GITHUB_CLIENT_ID:-}
      
      # === Collection Cache Configuration ===
      - COLLECTION_CACHE_TTL=86400
      - COLLECTION_CACHE_SIZE=100
      
      # === Performance Tuning ===
      - GOMAXPROCS=0
      - GOMEMLIMIT=2GiB
    
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 2GiB
        reservations:
          cpus: '1'
          memory: 512M
    
    # Health check
    healthcheck:
      test: ["CMD", "/app/nexs-mcp", "--version"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    
    # Security options
    security_opt:
      - no-new-privileges:true
    
    # Tmpfs mounts for temporary files
    tmpfs:
      - /tmp:size=500M,mode=1777

# Named volumes for persistence
volumes:
  nexs-mcp-models:
    driver: local
  nexs-mcp-cache:
    driver: local

# Network configuration (optional)
networks:
  default:
    name: nexs-mcp-network
    driver: bridge
